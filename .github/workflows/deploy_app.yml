name: Build E-commerce Application

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy_app.yml'
  workflow_dispatch:

# Variables de entorno
env:
  AZURE_WEBAPP_NAME_API: 'sebastian-ecommerce-api'     # Tu App Service del backend
  AZURE_WEBAPP_NAME_WEB: 'sebastian-ecommerce-web'     # Tu App Service del frontend
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20'

jobs:
  # ==================================================
  # JOB 1: BUILD BACKEND (.NET 8)
  # ==================================================
  Build-Backend:
    runs-on: ubuntu-latest
    outputs:
      backend-artifact: ${{ steps.upload.outputs.artifact-id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: |
          cd backend/EcommerceApi
          dotnet restore

      - name: Build application
        run: |
          cd backend/EcommerceApi
          dotnet build --configuration Release --no-restore

      - name: Run tests
        run: |
          cd backend/EcommerceApi
          dotnet test --configuration Release --no-build --verbosity normal || echo "No tests found"

      - name: Publish application
        run: |
          cd backend/EcommerceApi
          dotnet publish --configuration Release --no-build --output ./publish

      - name: Upload backend artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: backend-app
          path: backend/EcommerceApi/publish
          retention-days: 1

  # ==================================================
  # JOB 2: BUILD FRONTEND (Vue.js)
  # ==================================================
  Build-Frontend:
    runs-on: ubuntu-latest
    outputs:
      frontend-artifact: ${{ steps.upload.outputs.artifact-id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm run test:unit || echo "No unit tests configured"

      - name: Build for production
        run: |
          cd frontend
          npm run build

      - name: Upload frontend artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: frontend-app
          path: frontend/dist
          retention-days: 1

  # ==================================================
  # JOB 3: BUILD SUMMARY
  # ==================================================
  Build-Summary:
    needs: [Build-Backend, Build-Frontend]
    runs-on: ubuntu-latest
    
    steps:
      - name: Build Summary
        run: |
          echo "## 🏗️ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: .NET 8 API compiled successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: Vue.js app built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Ready for Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend URL**: Ready for https://${{ env.AZURE_WEBAPP_NAME_API }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: Ready for https://${{ env.AZURE_WEBAPP_NAME_WEB }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure Azure credentials in GitHub secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable deployment jobs in workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Set up database connection string" >> $GITHUB_STEP_SUMMARY

  # ==================================================
  # DEPLOYMENT JOBS (DISABLED - Enable after configuring secrets)
  # ==================================================
  # Deploy-Backend:
  #   needs: Build-Backend
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Download backend artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: backend-app
  #         path: ./backend-app
  #     - name: Login to Azure
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - name: Deploy to Azure App Service
  #       uses: azure/webapps-deploy@v2
  #       with:
  #         app-name: ${{ env.AZURE_WEBAPP_NAME_API }}
  #         package: ./backend-app

  # Deploy-Frontend:
  #   needs: Build-Frontend
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Download frontend artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: frontend-app
  #         path: ./frontend-app
  #     - name: Login to Azure
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - name: Deploy to Azure App Service
  #       uses: azure/webapps-deploy@v2
  #       with:
  #         app-name: ${{ env.AZURE_WEBAPP_NAME_WEB }}
  #         package: ./frontend-app